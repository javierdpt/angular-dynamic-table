<div
  [class.d-none]="
    !this.dataSource.dataStream$.getValue().length || !searchEnabled
  "
  class="search"
>
  <mat-icon>filter_alt</mat-icon>
  <input
    #search
    (input)="onSearchTerm(search.value)"
    [attr.data-lr]="labels.searchPlaceHolder"
    [placeholder]="labels.searchPlaceHolder"
  />
  <button
    type="button"
    mat-button
    tabindex="-1"
    *ngIf="search.value"
    matSuffix
    mat-icon-button
    aria-label="Clear search field"
    (click)="search.value = ''; onSearchTerm('')"
  >
    <mat-icon>close</mat-icon>
  </button>
</div>

<ng-container
  *ngIf="this.dataSource.dataStream$.getValue()?.length; else emptyMessage"
>
  <div [class.d-none]="!dataSource.noFilteredEntities$.getValue()">
    <table mat-table [dataSource]="dataSource" class="custom-shadow" matSort>
      <ng-container
        *ngFor="let disCol of columns; let colIndex = index"
        [matColumnDef]="disCol"
      >
        <th class="ps-2 pe-2" mat-header-cell *matHeaderCellDef mat-sort-header>
          {{ (disCol | startlize) || "" | titlecase }}
        </th>

        <td class="ps-2 pe-2" mat-cell *matCellDef="let element">
          <ng-container *ngIf="isArray(element[disCol])">
            <ng-container
              *ngIf="isNativeArray(element[disCol]); else objectArray"
            >
              <ul>
                <li *ngFor="let item of element[disCol]">{{ item }}</li>
              </ul>
            </ng-container>

            <ng-template #objectArray>
              <ng-container
                *ngIf="
                  displayAsItemsTable(element[disCol]);
                  else arrayAsKeyValPairTable
                "
              >
                <app-shared-dynamic-table
                  [searchEnabled]="searchEnabled && true"
                  class="custom-tb"
                  [data]="element[disCol]"
                  [outerSearchItem]="
                    enableOuterSearch ? searchTerms : undefined
                  "
                >
                </app-shared-dynamic-table>
              </ng-container>

              <ng-template #arrayAsKeyValPairTable>
                <ng-container
                  *ngFor="let item of element[disCol]; let i = index"
                >
                  <app-shared-dynamic-table
                    [searchEnabled]="searchEnabled && true"
                    class="custom-tb"
                    [data]="internalToPropObjectTableDef(item, 'Property Name')"
                    [outerSearchItem]="
                      enableOuterSearch ? searchTerms : undefined
                    "
                  >
                  </app-shared-dynamic-table>
                </ng-container>
              </ng-template>
            </ng-template>
          </ng-container>

          <app-shared-dynamic-table
            *ngIf="!isDate(element[disCol]) && isObject(element[disCol])"
            [searchEnabled]="searchEnabled && true"
            class="custom-tb"
            [data]="
              internalToPropObjectTableDef(element[disCol], 'Property Name')
            "
            [outerSearchItem]="enableOuterSearch ? searchTerms : undefined"
          >
          </app-shared-dynamic-table>

          <span
            *ngIf="isDate(element[disCol])"
            [innerHTML]="
              element[disCol]
                | date: 'YYYY-MM-dd HH:mm:ss'
                | highlightText: search.value
            "
          ></span>

          <span
            *ngIf="!isArray(element[disCol]) && !isObject(element[disCol])"
            [innerHTML]="element[disCol] | highlightText: search.value"
          ></span>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="columns"></tr>
      <tr mat-row *matRowDef="let row; columns: columns"></tr>
    </table>

    <mat-paginator
      [class.d-none]="!this.dataSource.dataStream$.getValue().length"
      class="mat-elevation-z3"
      [pageSizeOptions]="[5, 10, 20]"
      showFirstLastButtons
    >
    </mat-paginator>
  </div>

  <div
    *ngIf="!dataSource.noFilteredEntities$.getValue()"
    class="no-data custom-shadow p-4 mt-2 text-center"
  >
    <p [attr.data-lr]="labels.emptyFilterMsg">
      {{ labels.emptyFilterMsg! }} "{{ search.value }}""
    </p>
    <button
      class="mt-2"
      mat-button
      color="primary"
      (click)="search.value = ''; onSearchTerm(search.value)"
    >
      <mat-icon>search</mat-icon>
      <span class="ms-2">Clear search</span>
    </button>
  </div>
</ng-container>

<ng-template #emptyMessage>
  <div class="no-data p-4 mb-2 mt-2 text-center">
    <p>{{ labels.emptyDataMsg }}</p>
  </div>
</ng-template>
